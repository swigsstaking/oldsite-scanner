<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old .ch Scanner - D√©tecteur de vieux sites suisses</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls input, .controls select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .controls input:focus, .controls select:focus {
            outline: none;
            border-color: #667eea;
        }

        .controls button {
            padding: 10px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .job-controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .job-controls h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .job-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .job-buttons button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-fetch {
            background: #3498db;
            color: white;
        }

        .btn-fetch:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-scan {
            background: #2ecc71;
            color: white;
        }

        .btn-scan:hover:not(:disabled) {
            background: #27ae60;
        }

        .btn-stop {
            background: #e74c3c;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #c0392b;
        }

        .job-status {
            margin-left: 20px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95em;
            color: #666;
        }

        .job-status.fetching {
            background: #d4edff;
            color: #2980b9;
        }

        .job-status.scanning {
            background: #d5f4e6;
            color: #27ae60;
        }

        .job-status.idle {
            background: #f8f9fa;
            color: #666;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-high {
            background: #ff4757;
            color: white;
        }

        .score-medium {
            background: #ffa502;
            color: white;
        }

        .score-low {
            background: #2ed573;
            color: white;
        }

        .domain-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .domain-link:hover {
            text-decoration: underline;
        }

        .reasons {
            color: #666;
            font-size: 0.9em;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0f0f0;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: #e0e0e0;
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            padding-right: 40px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .detail-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls input, .controls select, .controls button {
                width: 100%;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px;
            }

            .reasons {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üï∞Ô∏è Old .ch Scanner</h1>
            <p class="subtitle">D√©tecteur automatique de sites suisses obsol√®tes</p>
        </header>

        <div class="job-controls">
            <h3>‚öôÔ∏è Contr√¥le des jobs</h3>
            <div class="job-buttons">
                <button id="btnFetch" class="btn-fetch">1. üåê R√©cup√©rer les domaines (.ch)</button>
                <button id="btnScan" class="btn-scan">2. üîç Scanner</button>
                <button id="btnStop" class="btn-stop">‚èπÔ∏è Arr√™ter</button>
                <span id="jobStatus" class="job-status">√âtat: chargement...</span>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalScans">-</div>
                <div class="stat-label">Scans totaux</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">-</div>
                <div class="stat-label">Score moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="maxScore">-</div>
                <div class="stat-label">Score maximum</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="domainsCount">-</div>
                <div class="stat-label">Domaines uniques</div>
            </div>
        </div>

        <div class="controls">
            <label for="minScore">Score minimum:</label>
            <input type="number" id="minScore" value="40" min="0" max="200">
            
            <label for="limit">Limite:</label>
            <select id="limit">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200" selected>200</option>
                <option value="500">500</option>
            </select>
            
            <button onclick="loadScans()">üîÑ Actualiser</button>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">Chargement des donn√©es...</div>
            <table id="scansTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Domaine</th>
                        <th>Score</th>
                        <th>Code HTTP</th>
                        <th>Raisons</th>
                        <th>Latence (ms)</th>
                        <th>Date scan</th>
                    </tr>
                </thead>
                <tbody id="scansBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 id="modalDomain">D√©tails du scan</h2>
            
            <div class="detail-grid">
                <div class="detail-label">Score:</div>
                <div class="detail-value" id="modalScore"></div>
                
                <div class="detail-label">Code HTTP:</div>
                <div class="detail-value" id="modalHttpCode"></div>
                
                <div class="detail-label">Latence:</div>
                <div class="detail-value" id="modalLatency"></div>
                
                <div class="detail-label">Date scan:</div>
                <div class="detail-value" id="modalDate"></div>
            </div>

            <div class="detail-section">
                <h3>üîç Raisons de d√©tection</h3>
                <div class="detail-content" id="modalReasons"></div>
            </div>

            <div class="detail-section">
                <h3>üìã Headers HTTP</h3>
                <div class="detail-content" id="modalHeaders"></div>
            </div>

            <div class="detail-section">
                <h3>üìÑ √âchantillon HTML</h3>
                <div class="detail-content" id="modalSample"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const btnFetch = document.getElementById('btnFetch');
        const btnScan = document.getElementById('btnScan');
        const btnStop = document.getElementById('btnStop');
        const jobStatus = document.getElementById('jobStatus');

        // Fonction pour rafra√Æchir le statut des jobs
        async function refreshJobStatus() {
            try {
                const res = await fetch('/api/job/status');
                const data = await res.json();
                
                // Mettre √† jour le texte du statut
                let statusText = `√âtat: ${data.state}`;
                if (data.pid) {
                    statusText += ` (PID ${data.pid})`;
                }
                if (data.domains_count > 0) {
                    statusText += ` | ${data.domains_count} domaines`;
                }
                jobStatus.textContent = statusText;
                
                // Mettre √† jour la classe CSS
                jobStatus.className = `job-status ${data.state}`;
                
                // G√©rer l'√©tat des boutons
                if (data.state === 'idle') {
                    btnFetch.disabled = false;
                    btnScan.disabled = !data.domains_file_exists;
                    btnStop.disabled = true;
                } else {
                    btnFetch.disabled = true;
                    btnScan.disabled = true;
                    btnStop.disabled = false;
                }
            } catch (error) {
                console.error('Erreur lors du rafra√Æchissement du statut:', error);
                jobStatus.textContent = '√âtat: erreur';
            }
        }

        // √âv√©nements des boutons
        btnFetch.addEventListener('click', async () => {
            try {
                const res = await fetch('/api/fetch/start', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'fetch_started') {
                    alert('‚úÖ R√©cup√©ration des domaines lanc√©e!');
                } else if (data.status === 'busy') {
                    alert('‚ö†Ô∏è Un job est d√©j√† en cours: ' + data.state);
                }
                await refreshJobStatus();
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        btnScan.addEventListener('click', async () => {
            try {
                const res = await fetch('/api/scan/start', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'scan_started') {
                    alert('‚úÖ Scan lanc√©! Les r√©sultats appara√Ætront progressivement.');
                    // Recharger les scans apr√®s 10 secondes
                    setTimeout(loadScans, 10000);
                } else if (data.status === 'busy') {
                    alert('‚ö†Ô∏è Un job est d√©j√† en cours: ' + data.state);
                } else if (data.status === 'error') {
                    alert('‚ùå ' + data.message);
                }
                await refreshJobStatus();
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        btnStop.addEventListener('click', async () => {
            if (!confirm('Voulez-vous vraiment arr√™ter le job en cours?')) {
                return;
            }
            try {
                const res = await fetch('/api/job/stop', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'stopped') {
                    alert('‚úÖ Job arr√™t√©: ' + data.job_type);
                } else if (data.status === 'not_running') {
                    alert('‚ÑπÔ∏è Aucun job en cours');
                }
                await refreshJobStatus();
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalScans').textContent = data.total_scans;
                document.getElementById('avgScore').textContent = data.avg_score.toFixed(1);
                document.getElementById('maxScore').textContent = data.max_score;
                document.getElementById('domainsCount').textContent = data.domains_count;
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        async function loadScans() {
            const minScore = document.getElementById('minScore').value;
            const limit = document.getElementById('limit').value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('scansTable').style.display = 'none';
            
            try {
                const response = await fetch(`/api/scans?min_score=${minScore}&limit=${limit}`);
                const data = await response.json();
                
                const tbody = document.getElementById('scansBody');
                tbody.innerHTML = '';
                
                data.items.forEach(scan => {
                    const row = document.createElement('tr');
                    row.onclick = () => showDetails(scan.id);
                    
                    const scoreClass = scan.score >= 80 ? 'score-high' : 
                                      scan.score >= 50 ? 'score-medium' : 'score-low';
                    
                    const date = new Date(scan.scan_time * 1000).toLocaleString('fr-CH');
                    
                    row.innerHTML = `
                        <td><a href="http://${scan.domain}" target="_blank" class="domain-link" onclick="event.stopPropagation()">${scan.domain}</a></td>
                        <td><span class="score-badge ${scoreClass}">${scan.score}</span></td>
                        <td>${scan.http_code}</td>
                        <td><div class="reasons">${scan.reasons}</div></td>
                        <td>${scan.latency_ms}</td>
                        <td>${date}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('scansTable').style.display = 'table';
                
            } catch (error) {
                console.error('Erreur lors du chargement des scans:', error);
                document.getElementById('loading').textContent = 'Erreur lors du chargement des donn√©es';
            }
        }

        async function showDetails(scanId) {
            try {
                const response = await fetch(`/api/scans/${scanId}`);
                const scan = await response.json();
                
                document.getElementById('modalDomain').textContent = scan.domain;
                document.getElementById('modalScore').textContent = scan.score;
                document.getElementById('modalHttpCode').textContent = scan.http_code;
                document.getElementById('modalLatency').textContent = `${scan.latency_ms} ms`;
                document.getElementById('modalDate').textContent = new Date(scan.scan_time * 1000).toLocaleString('fr-CH');
                document.getElementById('modalReasons').textContent = scan.reasons;
                document.getElementById('modalHeaders').textContent = scan.headers;
                document.getElementById('modalSample').textContent = scan.sample_head;
                
                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('Erreur lors du chargement des d√©tails:', error);
                alert('Erreur lors du chargement des d√©tails');
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Fermer la modal en cliquant en dehors
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeModal();
            }
        });

        // Fermer la modal avec √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Charger les donn√©es au d√©marrage
        loadStats();
        loadScans();
        refreshJobStatus();
        
        // Rafra√Æchir le statut des jobs toutes les 5 secondes
        setInterval(refreshJobStatus, 5000);
    </script>
</body>
</html>
